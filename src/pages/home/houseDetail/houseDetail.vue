<script lang="ts" setup>
import { ref } from 'vue'
import { onLoad, onShow } from '@dcloudio/uni-app'
import type { THouseInfo } from '@/types/home'
import SpecialItem from '../components/SpecialItem.vue'
import type { DefineComponent } from 'vue'
import BookTool from './components/BookTool.vue'

const moreHouseList = ref<THouseInfo[]>([])

// è·å–æ›´å¤šæˆ¿æºåˆ—è¡¨
function getMoreHouseList() {
  // ğŸ“Œè°ƒå–æ¥å£
  setTimeout(() => {
    moreHouseList.value = []
    for (let i = 0; i < 4; i++) {
      moreHouseList.value.push({
        id: i.toString(),
        pictures: [
          [
            'https://img02.mockplus.cn/image/2020-09-08/552a6c00-f12c-11ea-9d17-11b700b7f8d3.jpg',
            'https://img02.mockplus.cn/image/2020-09-08/5edfc600-f12c-11ea-9948-8d15b5335fa1.jpg',
            'https://img02.mockplus.cn/image/2020-09-08/64537eb0-f12c-11ea-9d17-11b700b7f8d3.jpg',
            'https://img02.mockplus.cn/image/2020-09-08/6b242f50-f12c-11ea-9d17-11b700b7f8d3.jpg'
          ][Math.floor(Math.random() * 4)]
        ],
        facility: 'æ•´å¥—æˆ¿å­ Â· 1å®¤1å«1åºŠ',
        tags: [
          {
            id: '1',
            text: 'å¤ªå¤é‡Œ'
          },
          {
            id: '100',
            text: 'è¶…èµæˆ¿ä¸œ'
          },
          {
            id: '102',
            text: 'å®‰å¿ƒä½'
          },
          {
            id: '103',
            text: 'å…è´¹åœè½¦'
          },
          {
            id: '104',
            text: 'é™„è¿‘åœ°é“'
          },
          {
            id: '105',
            text: 'å¯ä»¥åšé¥­'
          }
        ],
        title: 'å¯“è§Â·æ¶ˆæ¯’å®‰å¿ƒä½Â·è§‚æ™¯plus',
        currentPrice: 394,
        originalPrice: 788,
        discountTag: '5æŠ˜ Â· ä»…é™ä»Šæ™š',
        score: Math.floor(Math.random() * 5) + 1,
        city: 'æˆéƒ½å¸‚'
      })
    }
  }, 500)
}

onShow(() => {
  getMoreHouseList()
})

// å…³é—­è¯¦æƒ…é¡µï¼Œè¿”å›ä¸Šä¸€ä¸ªé¡µé¢
function handleClosePage() {
  uni.navigateBack({ delta: 1 })
}

const sharePopup = ref<DefineComponent>()

// åˆ†äº«
function handleShare() {
  sharePopup.value!.open()
}

// æ˜¯å¦å·²æ”¶è—
const collected = ref(false)

// æ”¶è—
function handleCollect() {
  // ğŸ“Œè°ƒå–æ¥å£
  setTimeout(() => {
    collected.value = !collected.value
  }, 10)
}

const houseDetail = ref<THouseInfo>({
  id: '',
  pictures: [],
  facility: '',
  tags: [],
  title: '',
  currentPrice: NaN,
  originalPrice: NaN,
  discountTag: '',
  city: ''
})

let id: string
onLoad((query) => {
  id = query!.id
  getHouseDetail()
})

// è·å–æˆ¿æºè¯¦æƒ…
function getHouseDetail() {
  // ğŸ“Œè°ƒå–æ¥å£
  setTimeout(() => {
    houseDetail.value = {
      id,
      pictures: [
        'https://img02.mockplus.cn/image/2020-09-08/a1d0e0d0-f12b-11ea-bb18-5957e87ab951.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/7cd54210-f150-11ea-aeeb-2db5a91e8f48.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/95aafc30-f150-11ea-bf79-4bf7403aaa5c.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/86be7d50-f150-11ea-aeeb-2db5a91e8f48.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/9eda3640-f150-11ea-aeeb-2db5a91e8f48.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/a4517160-f150-11ea-8c98-e56c1a531de9.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/ac7492a0-f150-11ea-9948-8d15b5335fa1.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/b1f2ab90-f150-11ea-bb18-5957e87ab951.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/b749db90-f150-11ea-926a-45b4090c6c64.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/c69a9a80-f150-11ea-bf79-4bf7403aaa5c.jpg',
        'https://img02.mockplus.cn/image/2020-09-08/e28cd6e0-f150-11ea-926a-45b4090c6c64.jpg'
      ],
      facility: 'æ•´å¥—æˆ¿å­ Â· 1å®¤1å«1åºŠ',
      tags: [
        {
          id: '1',
          text: 'å¤ªå¤é‡Œ'
        },
        {
          id: '100',
          text: 'è¶…èµæˆ¿ä¸œ'
        },
        {
          id: '102',
          text: 'å®‰å¿ƒä½'
        },
        {
          id: '103',
          text: 'å…è´¹åœè½¦'
        },
        {
          id: '104',
          text: 'é™„è¿‘åœ°é“'
        },
        {
          id: '105',
          text: 'å¯ä»¥åšé¥­'
        }
      ],
      title:
        'é‡è§ Â· æ™¯è§‚Pluså¤§åºŠæˆ¿ Â· ç½‘çº¢è§‚æ™¯éœ²å° Â· è¿‘æ˜¥ç†™è·¯ Â· å¤ªå¤é‡Œ Â· ç†ŠçŒ«åŸºåœ° Â· å¯åœè½¦ Â· å¯å¼€å‘ç¥¨',
      score: 5.0,
      currentPrice: 394,
      originalPrice: 788,
      discountTag: 'äº«å—8æœˆ31æ—¥-11æœˆæœŸé—´çš„9.8æŠ˜ä¼˜æƒ ',
      city: 'æˆéƒ½å¸‚',
      introduce:
        'æ­¤æˆ¿å‹æœ‰å¤šå¥—åœ¨åŒä¸€æ ‹æ¥¼å†…ï¼Œå¯é¢„è®¢å¤šå¥—ï¼Œå…¬å¯“ä¸€å…±æœ‰6ç§æˆ¿å‹ï¼Œè£…ä¿®é£æ ¼ç›¸åŒï¼Œç‚¹å‡»æˆ¿ä¸œå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ'
    }
  }, 500)
}

// è”ç³»æˆ¿ä¸œ
function handleContactLandlord() {
  uni.makePhoneCall({
    phoneNumber: '13111111111'
  })
}
</script>

<template>
  <view class="house-detail">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <uni-nav-bar class="custom-nav-bar" :border="false" backgroundColor="transparent">
      <template #left>
        <uni-icons type="closeempty" size="20" color="#000" @tap="handleClosePage" />
      </template>
      <template #right>
        <uni-icons class="share-icon" type="redo" size="20" color="#000" @tap="handleShare" />
        <uni-icons
          :type="collected ? 'heart-filled' : 'heart'"
          size="20"
          color="#a30014"
          @tap="handleCollect"
        />
      </template>
    </uni-nav-bar>
    <!-- å°é¢ä¿¡æ¯ -->
    <image class="cover-info" :src="houseDetail.pictures[0]" mode="aspectFill" />
    <!-- åŸºç¡€ä¿¡æ¯ -->
    <view class="base-info p24">
      <view class="notes">
        <uni-icons type="info-filled" color="#f59b22" size="20" />
        <text class="quality">ä¼˜è´¨æˆ¿æº</text>
        <text class="about">{{ houseDetail.city }} Â· æˆå¥—å…¬å¯“</text>
      </view>
      <view class="title">{{ houseDetail.title }} </view>
      <TagGroup :tagList="houseDetail.tags" backgroundColor="#fff" />
    </view>
    <!-- ä¼˜æƒ ä¿¡æ¯ -->
    <view class="discount-info p24">
      <view class="discount-description">
        <view class="discount-tag">{{ houseDetail.discountTag }}</view>
        <view>åœ¨84å¤©å†…å®Œæˆé¢„è®¢ï¼Œé”å¥½é™æ—¶å¥½ä»·</view>
      </view>
      <uni-icons type="paperclip" color="#008a85" size="30" />
    </view>
    <!-- æˆ¿æºæ¦‚å†µ -->
    <view class="general-info p24">
      <h3>æˆ¿æºæ¦‚å†µ</h3>
      <uni-grid :column="4" :showBorder="false" :square="false">
        <uni-grid-item v-for="item in 4" :key="item">
          <uni-icons type="home" />
          <view class="info">1é—´å§å®¤</view>
        </uni-grid-item>
      </uni-grid>
      <uni-row :gutter="20">
        <uni-col :span="12">
          <uni-card>
            <view>æ•´ä¸ªæˆ¿æº</view>
            <view>ç‹¬äº«æ‰€æœ‰ç©ºé—´ï¼Œæ— éœ€ä¸ä»–äººå…±ç”¨</view>
          </uni-card>
        </uni-col>
        <uni-col :span="12">
          <uni-card>
            <view>å§å®¤1</view>
            <view>1å¼ 1.5ç±³å®½åŒäººåºŠ</view>
          </uni-card>
        </uni-col>
      </uni-row>
    </view>
    <!-- æˆ¿æºä»‹ç» -->
    <view class="intro-info p24">
      <h3>æˆ¿æºä»‹ç»</h3>
      <p class="mtb24 two-line-overflow">
        {{ houseDetail.introduce }}
      </p>
      <view class="view-more">æŸ¥çœ‹æ›´å¤š</view>
    </view>
    <!-- æˆ¿å®¢è¯„ä»· -->
    <view class="evaluate-info p24">
      <h3>æˆ¿å®¢è¯„ä»·</h3>
    </view>
    <!-- æˆ¿æºä½ç½® -->
    <view class="location-info p24">
      <h3>æˆ¿æºä½ç½®</h3>
      <view class="trip-info mt24">å‡ºè¡ŒåŠå‘¨è¾¹ä¿¡æ¯</view>
      <p class="mtb24 two-line-overflow"
        >å…¬å¯“é…å¥—è®¾æ–½å®Œå–„ï¼Œé¡¶æ¥¼æœ‰ç©ºä¸­èŠ±å›­ã€èŠ±å›­å¼é…’å§ã€æ˜Ÿç©ºä¹¦å§ã€å’–å•¡å§ç§äººå½±é™¢ã€å¥èº«æˆ¿ç­‰ã€‚
      </p>
      <view class="map-container" />
      <view class="mtb24">æˆ¿æºä½äºæˆéƒ½å¸‚ï¼Œå››å·çœï¼Œä¸­å›½ Â· é¢„è®¢åå¯æŸ¥çœ‹è¯¦ç»†åœ°å€</view>
      <view class="contact-landlord" @tap="handleContactLandlord">è”ç³»æˆ¿ä¸œ</view>
    </view>
    <!-- æ³¨æ„äº‹é¡¹ -->
    <view class="notice-info p24">
      <h3>æ³¨æ„äº‹é¡¹</h3>
      <view>å…¥ä½é€€æˆ¿æ—¶é—´</view>
      <view>å…¥ä½ï¼šä¸‹åˆ2ï¼š00åã€é€€æˆ¿ï¼šä¸‹åˆ12ï¼š00</view>
    </view>
    <!-- æ›´å¤šä½å¤„ -->
    <view class="more-info p24">
      <h3>æ›´å¤šä½å¤„</h3>
      <uni-grid :column="2" :show-border="false" :square="false">
        <uni-grid-item
          v-for="specialHouse in moreHouseList"
          :key="specialHouse.id"
          :index="Number(specialHouse.id)"
        >
          <SpecialItem :houseInfo="specialHouse" />
        </uni-grid-item>
      </uni-grid>
    </view>
    <!-- <uni-goods-nav :options="options" :fill="true" :button-group="buttonGroup" /> -->
    <BookTool :data="houseDetail" />
    <uni-popup ref="sharePopup" type="share">
      <uni-popup-share title="åˆ†äº«åˆ°" />
    </uni-popup>
  </view>
</template>

<style lang="scss" scoped>
.house-detail {
  padding: var(--status-bar-height) 0 162rpx;
  color: #000;
  .custom-nav-bar {
    position: fixed;
    z-index: 1;
    left: 0;
    right: 0;
    top: var(--status-bar-height);
    :deep(.uni-navbar__header-btns-right) {
      width: 160rpx !important;
    }
    .uni-icons {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 64rpx;
      height: 64rpx;
      background-color: #fff;
      border-radius: 50%;
      &.share-icon {
        margin-right: 24rpx;
      }
    }
  }

  .cover-info {
    width: 100%;
  }
  .base-info {
    border-bottom: 2rpx solid $border-color-light-gray;
    .notes {
      line-height: 2;
      .quality {
        margin: 0 20rpx;
      }
      .about {
        color: $uni-color-primary;
      }
    }
    .title {
      font-size: 38rpx;
    }
  }
  .discount-info {
    display: flex;
    align-items: center;
    border-bottom: 14rpx solid $border-color-light-gray;
    .discount-description {
      flex: 1;
      .discount-tag {
        font-weight: bold;
        margin-bottom: 15rpx;
      }
    }
  }
  .general-info {
    border-bottom: 14rpx solid $border-color-light-gray;
    .uni-card {
      display: flex;
      height: 176rpx;
      margin: 0 !important;
    }
  }
  .intro-info {
    border-bottom: 14rpx solid $border-color-light-gray;

    .view-more {
      color: $green;
    }
  }
  .evaluate-info {
    border-bottom: 14rpx solid $border-color-light-gray;
  }
  .location-info {
    border-bottom: 14rpx solid $border-color-light-gray;
    .map-container {
      height: 276rpx;
      background-color: $bgc-placeholder;
    }
    .contact-landlord {
      color: $green;
    }
  }
  .notice-info {
    border-bottom: 14rpx solid $border-color-light-gray;
  }
  .more-info {
  }
}
</style>
